Goodcorp is opening up a child company called Gamecorp that will develop a multiplayer online battle arena game to compete against the top eSports game - DOTA and take the eSports world by storm. Goodcorp’s top exec, Alice, wants to know some things from the security intelligence team and you’ve been tasked to answer them. Here’s her memo she left for you



> Can you confirm APT41 is indeed a threat for us?

> Is spearphishing a likely initial attack, and what about remote administration software?

> Is there anything specific about their foothold or privilege escalation techniques?

> We also have a travel industry division from a child company we own that has heavily fortified themselves against APT39. Are we able to leverage any defense strategies implemented from there?

> Ultimately, with what you conclude, what should be our areas of focus for a strategy?



\\\ APT 41 \\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\

- Initially targeted the gaming industry
- Has broadened their scope of industry substantially 
- targets virtual currencies \ in - game currencies 
- based out of china \ state sponsored
- heavily financially motivated 
- operates within the 18:00 to 7:00 window



\\\ TTPS / INITIAL COMPROMISE \

\ known to use teamviewer heavily
\ exploits these vulnerabilities \ should run a scan for these 
- CVE-2012-0158
- CVE-2015-1641
- CVE-2017-0199
- CVE-2017-11882
- CVE-2019-3396
\ known to conduct spearphishing 

teamviewer can be used in conjunction with spearphishing attacks and binary hijacking 



\\\ TTPS / FOOTHOLD \

> Ensure HTTP payload delivery cannot be executed from PowerShell and CMD

\ known to use cobalt strike beacon 
\ known to exploit sticky keys vulnerabilities 
\ uses C:\windows\temp as a staging area 
\ masquerades as common antivirus: 
- Kasparsky.net
- macfee.ga
- symanteclabs.com 

\\\ TTPS / ENUMERATION \ EXFILTRATION \

\ known to use windows credential editor
\ known to dump LSASS memory as a means of lateral movement within a network
\ has enumerated IP addresses of network resources and used the netstat command as part of network reconnaissance. The group has also used a malware variant, HIGHNOON, to enumerate active RDP sessions.


TCM Security 





> abuse of application layer protocol 

- Adversaries may communicate using application layer protocols to avoid detection/network filtering by blending in with existing traffic. Commands to the remote system, and often the results of those commands, will be embedded within the protocol traffic between the client and server


<M> Network intrusion detection and prevention systems that use network signatures to identify traffic for specific adversary malware can be used to mitigate activity at the network level

<AI> One way to protect against exploitation of the application layer protocol is by using a web application firewall (WAF). A WAF applies a set of rules to HTTP/S conversations between applications12. WAFs are commonly used to secure API platforms, as they are able to prevent misuse and exploitation and help mitigate application-layer DDoS attacks


> abuse of BITS jobs 

- APT41 may abuse BITS jobs to persistently execute code and perform various background tasks. Windows Background Intelligent Transfer Service (BITS) is a low-bandwidth, asynchronous file transfer mechanism exposed through Component Object Model (COM)
            COM is an IPC component of the native Windows API that enables interaction between software objects, or executable code that implements one or more interfaces.Through COM, a client object can call methods of server objects, which are typically binary Dynamic Link Libraries (DLL) or executables (EXE)

<M> Modify network and/or host firewall rules, as well as other network controls, to only allow legitimate BITS traffic

<M> Consider reducing the default BITS job lifetime in Group Policy or by editing the JobInactivityTimeout and MaxDownloadTime Registry values in HKEY_LOCAL_MACHINE\Software\Policies\Microsoft\Windows\BITS

<D> Monitor for newly constructed network activity generated by BITS. BITS jobs use HTTP(S) and SMB for remote connections and are tethered to the creating user and will only function when that user is logged on (this rule applies even if a user attaches the job to a service account)


> boot\logon autostart execution

- APT41 may configure system settings to automatically execute a program during system boot or logon to maintain persistence or gain higher-level privileges on compromised systems. Operating systems may have mechanisms for automatically running a program on system boot or account logon.

<M!> This type of attack technique cannot be easily mitigated with preventive controls since it is based on the abuse of system features.


Monitor DLL loads by processes, specifically looking for DLLs that are not recognized or not normally loaded into a process. Look for abnormal process behavior that may be due to a process loading a malicious DLL.

Monitor for newly constructed files that may configure system settings to automatically execute a program during system boot or logon to maintain persistence or gain higher-level privileges on compromised systems.

Monitor for changes made to files that may configure system settings to automatically execute a program during system boot or logon to maintain persistence or gain higher-level privileges on compromised systems.

Monitor for additions / changes to mechanisms that could be used to trigger autostart execution, such as relevant additions to the Registry.

Monitor for unusual kernel driver installation activity that may configure system settings to automatically execute a program during system boot or logon to maintain persistence or gain higher-level privileges on compromised systems.




>>>>>> /// Exploitation for Client Execution ///

> CVE-2012-0158 

- a remote code execution vulnerability that exists in the Windows common controls.An attacker could exploit this vulnerability by constructing a specially crafted webpage. When a user views this webpage, it could allow remote code execution.

- run a vulnerability scan for this asap on the network 

> spearphishing attachment 

<M> Block unknown or unused attachments by default that should not be transmitted over email as a best practice to prevent some vectors, such as .scr, .exe, .pif, .cpl, etc. Some email scanning devices can open and analyze compressed and encrypted formats, such as zip and rar that may be used to conceal malicious attachments.

Having a strong email authentication mechanism that enforces a strict sender domain using SPF and message integrity with DKIM. these combine to form our organizations DMARC that can be used inter-division  

Monitor and analyze SSL/TLS traffic patterns and packet inspection associated to protocol(s) that do not follow the expected protocol standards and traffic flows (e.g extraneous packets that do not belong to established flows, gratuitous or anomalous traffic patterns, anomalous syntax, or structure). Consider correlation with process monitoring and command line to detect anomalous processes execution and command line arguments associated to traffic patterns (e.g. monitor anomalies in use of files that do not normally initiate connections for respective protocol(s)). Filtering based on DKIM+SPF or header analysis can help detect when the email sender is spoofed

> block compiled.chm attachements from unknown sources, as APT41 is known for commonly using this



> both APTS use C2 servers, however APT39 uses HTTP in C2 comms, while APT41 uses DNS traffic instead. 

> both use mimikatz in pair with pwdump as a method of gaining credentials on a system by dumping LSASS memory and efiltrating the data using 



> data staging and exfiltration 

once again exploits BITS to exfiltrate data from a compromised machine by scheduling transfers of stolen data at times when network activity is low, making it less likely for the transfers to be detected.

Monitor processes that appear to be reading files from disparate locations and writing them to the same directory or file may be an indication of data being staged, especially if they are suspected of performing encryption or compression on the files, such as 7zip, RAR, ZIP, or zlib. 



> APT 41 uses gh0st RAT as a form of remote access 


because cobalt strike is relatively easy to get onto an unsecure system, and due to the numerous features its able to exploit once its on a victim machine based on commands from its C2 server, its difficult to fully mitigate or even detect cobalt strike within a network. A few things we can do to have the best shot against cobalt strike would be:

- TLSI <transport_layer_security_inspection>

       a security mechanism that allows enterprises to decrypt traffic, inspect the decrypted content for threats, and then re-encrypt the traffic before it enters or leaves the network1. This enhances visibility within boundary security products but introduces new risks. One risk is improper control of decrypted traffic. Once traffic is decrypted, if it is sent to another host for inspection (such as an external server), there is a risk that the traffic will be mishandled1. There’s also a risk of Certificate Authority Compromise in addition to creating a single point of failure within the network. Additionally, there’s a risk of insider access to decrypted traffic, and the possibility that the afformentioned insider is malicious.

        keep an eye on popular services. After exploiting a vulnerability, Cobalt Strike usually emulates a frequently used service so it can never be detected. running scans validated by a known trusted copy of the popular binary can help ensure our commonly used services are not being exploited by cobalt strike.

        SSL fingerprinting is a technique that associates an application and/or TLS library with parameters extracted from a TLS ClientHello by using a database of curated fingerprints this can be useful for detecting Cobalt Strike because it ships with a default SSL certificate for HTTPS communication2. By identifying this default certificate, we can detect and track cobalt strike activity within our network




exfiltration of data through C2 channel can be mitigated through the nkjetwork intrusion detection and prevention systems that use network signatures to identify traffic for specific adversary malware can be used to mitigate activity at the network level. Signatures are often for unique indicators within protocols and may be based on the specific obfuscation technique used by a particular adversary or tool, and will likely be different across various malware families and versions. Adversaries will likely change tool command and control signatures over time or construct protocols in such a way to avoid detection by common defensive tools.



a memory corruption vulnerability in Microsoft Office’s Equation Editor that enables remote code execution on vulnerable devices


> like using windows credential editor to dump password hashes from memory. will use mimikatz to perform the same function, but prefers windows credential editor

Manage the access control list for "Replicating Directory Changes" and other permissions associated with domain controller replication. [18] [19] Consider adding users to the "Protected Users" Active Directory security group. This can help limit the caching of users' plaintext credentials.

On Windows 10, enable Attack Surface Reduction (ASR) rules to secure LSASS and prevent credential stealing

With Windows 10, Microsoft implemented new protections called Credential Guard to protect the LSA secrets that can be used to obtain credentials through forms of credential dumping. It is not configured by default and has hardware and firmware system requirements. [22] It also does not protect against all forms of credential dumping.

Consider disabling or restricting NTLM.[24] Consider disabling WDigest authentication.

Ensure that local administrator accounts have complex, unique passwords across all systems on the network.

Windows:Do not put user or admin domain accounts in the local administrator groups across systems unless they are tightly controlled, as this is often equivalent to having a local administrator account with the same password on all systems.

Linux:Scraping the passwords from memory requires root privileges. Follow best practices in restricting access to privileged accounts to avoid hostile programs from accessing such sensitive regions of memory.

Ensure Domain Controller backups are properly secured.

> like to use teamviewer as an entry point

\\\\ yara rule for blocking a Teamviewer_backdoor \\\\

rule "Teamviewer_backdoor
{
meta: 
date='2019-04-14'
description='detects malicious teamviewer DLLS

strings

// PostMessageWhookfunction
$x1 = {55 8b ec 8b 45 0c 3d 12 01 00 00 75 05 83 c8 ff eb 12 8b 55 14 52 8b 55 10 52 50 8b 45 08 50 e8}

condition
uint16(0) == 0x5a4d and $x1
}


> installs to C:\windows\temp often

> malicious attachment is delivered and ultimately uses teamviewer to execute a malicious binary



















initial compromise
\ known to use teamviewer heavily

\ likes using windows credential editor to dump password hashes from memory. will use mimikatz to
 perform the same function, but prefers windows credential editor

\ known to conduct spearphishing to conduct the delivery of a malicious attachment that ultimately 
uses teamviewer to execute a malicious binary


\\\ TTPS / FOOTHOLD \
\ known to use and rely on their cobalt strike beacon 
\ known to frequently use Windows Credential Editor to dump password hashes from memory and 
authenticate other user accounts 
\ known to exploit sticky keys vulnerabilities 
\ uses C:\windows\temp as a staging area 
\ masquerades as common antivirus: 
- Kasparsky.net
- macfee.ga
- symanteclabs.com 
\\\ TTPS / ENUMERATION \ EXFILTRATION \
\ known to use windows credential editor
\ known to dump LSASS memory as a means of lateral movement within a network
\ has enumerated IP addresses of network resources and used the netstat command as part of 
network reconnaissance. The group has also used a malware variant, HIGHNOON, to enumerate 
active RDP sessions.
\ makes use of mimikatz, procdump, and BITS processes to enumerate and dump LSASS memory data
\ uses an open source RAT named gh0st RAT in some instances for remote access